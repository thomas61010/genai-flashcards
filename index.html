<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>生成AIパスポート・フラッシュカード</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0b1220; --muted:#6b7280;
    --accent:#0a84ff; --line:#e5e7eb; --btn-bg:#ffffff; --btn-bd:#d1d5db;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{
    margin:0; padding:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Hiragino Sans","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;
    line-height:1.6;
  }
  header{
    position:sticky; top:0; z-index:10; background:rgba(246,247,251,.92);
    backdrop-filter:saturate(1.2) blur(8px);
    border-bottom:1px solid var(--line); padding:env(safe-area-inset-top) 12px 10px 12px;
  }
  .wrap{max-width:720px; margin:0 auto; padding:0 8px;}
  .hrow{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  h1{font-size:17px; margin:6px 0 10px 0; font-weight:700;}
  .controls{display:flex; gap:8px;}
  input[type="search"],select,button{
    font-size:16px; padding:10px 12px; border-radius:12px;
    border:1px solid var(--btn-bd); background:var(--btn-bg); color:var(--text);
  }
  input[type="search"]{flex:1; min-width:40%;}
  button.primary{background:var(--accent); color:#fff; border-color:var(--accent);}
  main{padding:16px;}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    padding:20px 18px; box-shadow:0 6px 20px rgba(0,0,0,.06);
    min-height:42vh; display:flex; flex-direction:column; justify-content:center; gap:14px;
    touch-action: manipulation; 
  }
  .term{font-size:clamp(18px,4.6vw,24px); font-weight:700;}
  .meaning{font-size:clamp(16px,4.2vw,20px);}
  .muted{color:var(--muted);}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
  .actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
  .pill{padding:6px 10px; background:#f1f5f9; border:1px solid var(--line); border-radius:999px; font-size:12px;}
  footer{padding:18px; text-align:center; color:var(--muted); font-size:13px;}
  .hidden{display:none;}
  .lookup-wrap{display:flex; gap:8px; margin:12px auto 0; max-width:720px}
.lookup-wrap input{flex:1; padding:12px; border:1px solid var(--btn-bd); border-radius:12px; background:var(--btn-bg)}
.lookup-wrap button{padding:0 14px; border:1px solid var(--btn-bd); border-radius:12px; background:var(--btn-bg); font-size:16px}

.lkp-modal[hidden]{display:none}
.lkp-modal{position:fixed; inset:0; z-index:50}
.lkp-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.35)}
.lkp-panel{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(92vw,640px); max-height:80vh; overflow:auto; background:var(--card);
  border:1px solid var(--line); border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.22); padding:16px}
.lkp-head{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:12px}
.lkp-close{border:1px solid var(--btn-bd); background:var(--btn-bg); border-radius:10px; padding:6px 10px}
.lkp-sites{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px}
.lkp-site{padding:10px 14px; border:1px solid var(--btn-bd); border-radius:12px; background:var(--btn-bg)}
.lkp-recent{border-top:1px solid var(--line); padding-top:12px}
.lkp-recent-head{font-size:12px; color:var(--muted); margin-bottom:8px}
.lkp-recent-list{display:flex; gap:8px; flex-wrap:wrap}
.lkp-recent-list .chip{padding:6px 10px; border:1px solid var(--btn-bd); border-radius:999px; background:#f1f5f9; font-size:13px}
.lkp-clear{margin-top:8px; border:1px solid var(--btn-bd); background:var(--btn-bg); border-radius:10px; padding:6px 10px}
.lkp-hint{margin-top:10px; font-size:12px; color:var(--muted); text-align:right}

@media (max-width:640px){
  .lkp-panel{width:94vw; top:auto; bottom:0; transform:translate(-50%,0); border-bottom-left-radius:0; border-bottom-right-radius:0}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="hrow">
      <h1>生成AIパスポート・フラッシュカード</h1>
      <span class="pill" id="total">合計 - 枚</span>
    </div>
    <div class="controls">
      <input id="q" type="search" placeholder="検索（用語や説明）">
      <select id="filter" aria-label="フィルタ">
        <option value="all">すべて</option>
        <option value="unknown">未習得のみ</option>
        <option value="known">既習のみ</option>
      </select>
      <button id="shuffle" type="button" aria-label="順序をシャッフル">シャッフル</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="card" class="card" tabindex="0">
      <div class="term" id="term">読み込み中…</div>
      <div class="meaning hidden" id="meaning"></div>
      <div class="row">
        <div class="muted" id="progress"></div>
        <div><span class="pill" id="statuspill">未習得</span></div>
      </div>
      <div class="actions">
        <button id="prev" type="button">◀︎ 前へ</button>
        <button id="flip" type="button" class="primary">裏返す</button>
        <button id="next" type="button">次へ ▶︎</button>
      </div>
      <div class="actions">
        <button id="again" type="button">あとで</button>
        <button id="good" type="button" class="primary">覚えた</button>
        <button id="resetLocal" type="button">リセット</button>
      </div>
    </div>
    
    <!-- 外部検索（フッター操作の直下） -->
    <div class="lookup-wrap">
      <input id="lookup" type="search" placeholder="外部検索（用語）"
       aria-label="外部検索（用語）">
      <button id="lookupOpen" type="button" aria-label="検索モーダルを開く">🔍</button>
    </div>
  </div>
  <!-- 検索モーダル -->
  <div id="lookupModal" class="lkp-modal" role="dialog" aria-modal="true" aria-labelledby="lkpTitle" hidden>
    <div class="lkp-backdrop" data-close="1"></div>
    <div class="lkp-panel" role="document">
      <div class="lkp-head">
        <h2 id="lkpTitle">🔍 「<span id="lkpQuery">-</span>」を検索</h2>
        <button id="lkpClose" type="button" class="lkp-close" aria-label="閉じる">✕</button>
      </div>
      <div class="lkp-sites">
        <!-- 並び: Wiki / IPA / e-Gov / Qiita / Google -->
        <button class="lkp-site" data-site="wiki"  type="button">Wikipedia</button>
        <button class="lkp-site" data-site="ipa"   type="button">IPA</button>
        <button class="lkp-site" data-site="egov"  type="button">e-Gov</button>
        <button class="lkp-site" data-site="qiita" type="button">Qiita</button>
        <button class="lkp-site" data-site="google"type="button">Google</button>
      </div>
      <div class="lkp-recent">
        <div class="lkp-recent-head">最近の検索</div>
        <div id="lkpRecent" class="lkp-recent-list"></div>
        <button id="lkpClear" class="lkp-clear" type="button">履歴クリア</button>
      </div>
      <div class="lkp-hint">EnterでWikipediaに移動 / Escまたは背景タップ・下スワイプで閉じる</div>
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    追加は <code>window.flashcards.push(["用語","説明"])</code> でOK。ファイル内の <code>flashcards</code> 配列に追記すれば増えます。
  </div>
</footer>

<script>
/* ========= データ（全240枚：基礎→生成→LLM→RAG→評価→安全/法→ガバナンス） ========= */
const flashcards = [
  /* -- 基礎AI(30) -- */
  ["AI（人工知能）","機械で知的作業を実現する技術群。"],
  ["ダートマス会議","1956年、AI研究の起点。"],
  ["探索","状態空間を系統的に調べ解を探す。"],
  ["推論","既知の知識から新しい知見を導く。"],
  ["知識表現","事実や規則を機械で扱える形に表す。"],
  ["ルールベース","IF-THEN規則で判断。保守が重い。"],
  ["機械学習","データから規則/表現を学習。"],
  ["教師あり学習","入力とラベルで関数近似。"],
  ["教師なし学習","ラベル無しで構造発見。"],
  ["強化学習","報酬最大化の方策学習。"],
  ["過学習","訓練に過適合し汎化低下。"],
  ["正則化","複雑さに罰則で汎化改善。"],
  ["交差検証","データ分割で汎化性能推定。"],
  ["汎化","未知データでも性能維持。"],
  ["バイアス/バリアンス","系統誤差/分散のトレードオフ。"],
  ["ハイパーパラメータ","学習手順を決める外部設定。"],
  ["特徴量","学習の入力となる説明変数。"],
  ["次元の呪い","高次元で疎になり学習が困難。"],
  ["転移学習","既学習表現を別タスクに再利用。"],
  ["弱いAI","特化型のAI。現実の多く。"],
  ["強いAI","人間並み汎用知能の概念。"],
  ["第一次AIブーム","探索中心、組合せ爆発。"],
  ["第二次AIブーム","エキスパートシステム、知識獲得が壁。"],
  ["第三次AIブーム","深層学習で飛躍。"],
  ["教師データ","入力と正解ペア。品質が命。"],
  ["データ前処理","欠損/外れ値/正規化の整備。"],
  ["評価データ","チューニングに使わない検証用。"],
  ["再現率","陽性の取りこぼしの少なさ。"],
  ["適合率","予測陽性の正しさ。"],
  ["F1スコア","適合率と再現率の調和平均。"],

  /* -- 深層学習/生成(40) -- */
  ["ニューラルネット","多層の線形+非線形で表現学習。"],
  ["勾配降下法","損失を減らす方向に更新。"],
  ["誤差逆伝播","勾配を連鎖計算して学習。"],
  ["活性化関数","非線形性を与える要素。"],
  ["CNN","畳み込みで局所特徴抽出。"],
  ["RNN","時系列を順に処理。"],
  ["LSTM","長期依存に強いRNN。"],
  ["GRU","LSTMを軽量化したRNN。"],
  ["正規化層","学習安定化(BN/LN)。"],
  ["ドロップアウト","ユニット無効化で過学習抑制。"],
  ["注意機構","重要部分に重み付け。"],
  ["Transformer","自己注意中心の並列型。"],
  ["Encoder-Decoder","条件付き生成に強い構造。"],
  ["自己回帰","次トークンを逐次予測。"],
  ["拡散モデル","ノイズ除去過程で生成。"],
  ["VAE","潜在空間を確率的に学習。"],
  ["GAN","生成器と識別器の対戦学習。"],
  ["条件付き生成","ラベル/テキスト等で制御。"],
  ["LoRA","低ランクで効率的微調整。"],
  ["PEFT","一部だけ追加学習する手法群。"],
  ["量子化","重みを低ビット化し軽量化。"],
  ["蒸留","大モデルの知識を小モデルへ。"],
  ["RLHF","人間の好みを学び最適化。"],
  ["安全調整","危険出力を抑える学習。"],
  ["テキスト生成","要約/翻訳/校正/案出し等。"],
  ["画像生成","ペイント/修復/拡張/編集。"],
  ["音声生成","TTS/VC/読み上げ。"],
  ["動画生成","テキストから動く映像。"],
  ["スタイル転送","作風を他画像へ適用。"],
  ["アップスケーリング","高解像度化・劣化補正。"],
  ["ハルシネーション","もっともらしい誤情報の出力。"],
  ["プロンプト汚染","流出で再現されるリスク。"],
  ["安全な入力","機微や秘密を含めない。"],
  ["出力検閲","NG語/個人情報の遮断。"],
  ["Guardrails","出力制御の仕組み。"],
  ["レート制限","乱用と負荷を抑制。"],
  ["監査ログ","操作履歴を記録し追跡。"],
  ["追跡可能性","生成経路の可視化。"],
  ["モデルカード","モデルの用途/限界の説明書。"],

  /* -- LLM/プロンプト(40) -- */
  ["LLM","大規模言語モデル。汎用生成。"],
  ["コンテキスト","プロンプトに与える文脈。"],
  ["システムプロンプト","振る舞い・制約を先頭で定義。"],
  ["Few-shot","例を少数提示して誘導。"],
  ["Zero-shot","例なしで指示のみ。"],
  ["Chain-of-Thought","逐次思考を促す誘導。"],
  ["ReAct","推論+行動を往復で進める。"],
  ["出力フォーマット指定","JSON/表など形式を固定。"],
  ["温度","サンプリングのランダム性。"],
  ["トップP","確率質量上位から抽出。"],
  ["反復リライト","指示を小さく分けて改善。"],
  ["役割指定","専門家/採点者など立場付与。"],
  ["禁止事項の明示","やらないことを明記。"],
  ["境界条件","範囲・制約・例外の提示。"],
  ["参照スタイル","出典/URL/脚注の指示。"],
  ["停止語","生成を止めるトークン。"],
  ["トークン","サブワード単位の最小単位。"],
  ["コンテキスト長","一度に読める上限トークン。"],
  ["埋め込み（Embedding）","テキストのベクトル表現。"],
  ["ベクトルDB","埋め込みを近似探索で検索。"],
  ["類似度","コサイン/内積など距離指標。"],
  ["トークンコスト","長文ほど料金/遅延が増加。"],
  ["スロットリング","並列や頻度の制御。"],
  ["関数呼び出し","構造化ツール実行の指示。"],
  ["ツール利用","検索/計算/DBなど連携。"],
  ["エージェント","自律的にタスク連鎖実行。"],
  ["評価指標","品質/安全/事実性の測度。"],
  ["リトライ戦略","失敗時の再試行設計。"],
  ["プロンプト注入対策","入力をエスケープ/検証。"],
  ["キャッシュ","同一問合せの再利用で高速化。"],
  ["システム×ユーザ分離","権限境界を明示。"],
  ["脱漏対策","必要情報の聞き返し誘導。"],
  ["要件定義の骨子","目的/入力/出力/制約/評価。"],
  ["テストプロンプト集","代表ケースで回帰確認。"],
  ["ガードレールテスト","不適切出力の耐性検証。"],
  ["A/Bテスト","プロンプトや温度の比較。"],
  ["観測可能性","ログ/指標で運用監視。"],
  ["コスト最適化","小モデル/圧縮/要約で節約。"],
  ["レイテンシ最適化","コンテキスト削減/並列化。"],

  /* -- RAG/検索・評価(40) -- */
  ["RAG","検索拡張生成。外部知識で補強。"],
  ["インデクシング","文書→チャンク→埋め込み保存。"],
  ["チャンク分割","段落/見出しで適切な粒度。"],
  ["オーバーラップ","文脈維持のため一部重複。"],
  ["検索器","ベクトル/キーワード/ハイブリッド。"],
  ["再ランキング","候補をLLMや学習で並べ替え。"],
  ["スコア正規化","指標を比較可能に整形。"],
  ["引用挿入","回答に根拠を同梱。"],
  ["ソース帰属","出典・リンクを明記。"],
  ["コンテキスト圧縮","必要部分だけを要約抽出。"],
  ["禁止ドキュメント除外","社外/機微の誤混入を防ぐ。"],
  ["更新同期","クロール/Webhookで最新化。"],
  ["埋め込み更新","スキーマ変更時に再計算。"],
  ["メタデータ検索","タグ/日付/作者で絞込。"],
  ["質問再書き換え","検索に適した形へ変換。"],
  ["意図分類","Q&A/操作/定義などに分類。"],
  ["フェデレーション","複数データ源を横断検索。"],
  ["評価：精度","正解率・厳密一致。"],
  ["評価：再現性","同一質問で安定回答。"],
  ["評価：出典一致","引用が根拠と一致する度合い。"],
  ["評価：要約品質","忠実さ/網羅性/簡潔さ。"],
  ["評価：事実性","誤情報の少なさ。"],
  ["ヒューマンループ","人による継続評価を組込む。"],
  ["オフライン評価","ベンチで一括検証。"],
  ["オンライン計測","クリック/解決率/CSAT。"],
  ["ガードレール評価","安全/規約順守の確認。"],
  ["回帰テスト","変更で性能が悪化しないか。"],
  ["難問テスト","外挿/多段推論の耐性確認。"],
  ["データドリフト","分布変化で性能低下。"],
  ["監視ダッシュボード","指標を可視化・通知。"],
  ["フェイルセーフ回答","不明時は安全な返し方。"],
  ["エスカレーション","人/担当窓口へ切替。"],
  ["プロンプトバジェット","トークン配分の設計。"],
  ["キャッシュの一貫性","更新時の破棄/再計算。"],
  ["PII検出","個人情報を自動マスク。"],
  ["機密分類","公開/社内/秘の区分管理。"],
  ["監査対応ログ","問合せ/参照元/回答を保存。"],
  ["多言語RAG","言語横断の検索/回答。"],
  ["権限付き検索","ACLで文書アクセス制御。"],

  /* -- セキュリティ/法務(45) -- */
  ["セキュア設計","最小権限・境界防衛を徹底。"],
  ["入力検証","プロンプト注入/コード注入対策。"],
  ["出力検証","スキーマ/ポリシーで検査。"],
  ["レート制御","DoS/費用暴騰の抑止。"],
  ["秘匿化","鍵/トークンの安全管理。"],
  ["暗号化","転送/保管の暗号化。"],
  ["ゼロトラスト","常時検証・信頼しない設計。"],
  ["脅威モデリング","想定攻撃を洗い出し対策。"],
  ["責任分界点","ベンダ/利用者の役割分担。"],
  ["冗長化/バックアップ","障害時に復旧可能に。"],
  ["インシデント対応","検知→封じ込め→復旧手順。"],
  ["ログ最小化","必要最小限・保存期間の明確化。"],
  ["データ保持方針","保存目的/期間/破棄方法。"],
  ["データガバナンス","品質・所在・利用の統制。"],
  ["個人情報保護法","取得/利用/提供/安全管理の基本法。"],
  ["要配慮個人情報","センシティブ情報。慎重取扱い。"],
  ["匿名加工情報","再識別困難な加工データ。"],
  ["仮名加工情報","戻せる識別子置換。内部分析向け。"],
  ["個人関連情報","端末ID等、単体では個人特定不可。"],
  ["越境移転","域外提供時の適法性確認。"],
  ["クッキー規制","同意・透明性の確保。"],
  ["知的財産権","特許/著作/商標/意匠の総称。"],
  ["著作権","創作的表現の保護。"],
  ["引用","主従関係・出所明示が要件。"],
  ["二次的著作物","翻案等。原著作物の権利関与。"],
  ["著作者人格権","氏名表示/同一性保持等。譲渡不可。"],
  ["商用利用可否","規約・ライセンスの確認必須。"],
  ["オープンソースライセンス","MIT/Apache/GPL等の条件。"],
  ["利用規約","禁止事項/責任範囲/帰属を明記。"],
  ["データ提供同意","取得目的と範囲の明示。"],
  ["子ども配慮","年齢確認/保護者同意。"],
  ["金融関連規制","本人確認/記録保存など。"],
  ["医療情報ガイドライン","匿名化・二次利用の指針。"],
  ["広告表示規制","表現/根拠/誇大の禁止。"],
  ["景表法","不当表示の防止。"],
  ["不正競争防止法","営業秘密の不正取得/使用禁止。"],
  ["電子帳簿保存法","改ざん防止・検索性の要件。"],
  ["個人データ委託","契約/再委託/監督の義務。"],
  ["第三者提供","同意/オプトアウトの管理。"],
  ["情報漏えい対応","通知/公表/再発防止。"],
  ["削除請求への対応","権利と手続きを整備。"],
  ["監査と記録","内部/外部監査に耐える証跡。"],
  ["責任共有モデル","クラウドと利用者の分担。"],
  ["生成物の権利","人の創作関与なら著作物性。"],
  ["クレジット表記","出典/モデル名の明示。"],

  /* -- 倫理/原則/運用(45) -- */
  ["AI倫理","人間中心と社会的便益の両立。"],
  ["人間の監督","重要判断は人が最終決定。"],
  ["公平性","差別/不当な偏りを回避。"],
  ["透明性","仕組み/限界/データの開示。"],
  ["説明可能性","判断の理由を説明可能に。"],
  ["プライバシー","過剰収集を避け最小化。"],
  ["安全性","危険シナリオを事前に除去。"],
  ["堅牢性","異常入力・攻撃でも破綻しない。"],
  ["信頼性","安定した一貫動作。"],
  ["セキュリティ","守る設計と運用の徹底。"],
  ["持続可能性","環境/社会への配慮。"],
  ["包摂性","多様な利用者を想定。"],
  ["アクセシビリティ","誰もが使えるUI/字幕等。"],
  ["ステークホルダー対話","説明と合意形成を継続。"],
  ["苦情処理","問い合わせ/異議申立て窓口。"],
  ["ロールアウト計画","段階的公開と巻き戻し策。"],
  ["KPI設計","解決率/満足度/コスト等。"],
  ["運用手順書","異常時の対応を明文化。"],
  ["変更管理","影響評価→承認→展開。"],
  ["モデル更新方針","頻度/テスト/告知を定義。"],
  ["データライフサイクル","収集→利用→保管→破棄。"],
  ["リスク登録簿","識別/評価/対応の一覧。"],
  ["教育/研修","社内リテラシーを底上げ。"],
  ["ベンダ評価","信頼性/サポート/法令順守。"],
  ["PoC設計","目的/評価基準/期間/出口。"],
  ["本番移行基準","性能/安全/コストの閾値。"],
  ["SLA/品質保証","応答/可用性/窓口の合意。"],
  ["TCO試算","導入〜運用の総コスト。"],
  ["ROI評価","便益とコストの見積り。"],
  ["継続改善","計測→学習→改善の循環。"],
  ["撤退基準","中止判断と後片付け。"],
  ["エラー分類","プロンプト/データ/モデル/外部。"],
  ["アラート設計","閾値/頻度/通知先の定義。"],
  ["責任者の任命","オーナーと代行者を明確化。"],
  ["アクセス権管理","最小権限/監査。"],
  ["デューデリジェンス","導入前の多角的評価。"],
  ["倫理審査","高リスク案件の審議。"],
  ["ユーザ通知","自動生成である旨の明示。"],
  ["水印/識別","生成物を判別しやすく。"],
  ["データ出所管理","由来とライセンスの把握。"],
  ["SPOF回避","単一障害点をなくす。"],
  ["BCP","事業継続の計画。"],
  ["レジリエンス","障害からの回復力。"],
  ["国際動向の把握","EU/US/各国規制を追う。"],
  ["コミュニティ参加","知見共有と相互検証。"],
  ["モデルカード整備","用途/限界/倫理配慮を公開。"],
  ["リスクコミュニケーション","リスク/対応方針を関係者に分かりやすく伝える活動。"],
  ["変更履歴（チェンジログ）","更新内容を時系列に記録し、原因追跡と説明責任を支える文書。"]
];

/* ========= アプリ本体 ========= */
const elCard = document.getElementById('card');
const elTerm = document.getElementById('term');
const elMeaning = document.getElementById('meaning');
const elProgress = document.getElementById('progress');
const elStatus = document.getElementById('statuspill');
const elFlip = document.getElementById('flip');
const elPrev = document.getElementById('prev');
const elNext = document.getElementById('next');
const elAgain = document.getElementById('again');
const elGood = document.getElementById('good');
const elShuffle = document.getElementById('shuffle');
const elFilter = document.getElementById('filter');
const elQ = document.getElementById('q');
const elTotal = document.getElementById('total');

let order = [];
let idx = 0;
let showingMeaning = false;
const storeKey = "genai_passport_known_v1";
function loadKnown(){ try{ return new Set(JSON.parse(localStorage.getItem(storeKey)||"[]")); }catch(e){ return new Set(); } }
function saveKnown(s){ try{ localStorage.setItem(storeKey, JSON.stringify(Array.from(s))); }catch(e){} }
let known = loadKnown();

function norm(s){ return (s||"").toLowerCase(); }

function applyFilterAndSearch(){
  const mode = elFilter.value;
  const q = norm(elQ.value.trim());
  order = flashcards.map((_,i)=>i).filter(i=>{
    const k = norm(flashcards[i][0] + " " + flashcards[i][1]);
    const match = !q || k.includes(q);
    const isKnown = known.has(i);
    if(mode==="known") return match && isKnown;
    if(mode==="unknown") return match && !isKnown;
    return match;
  });
  if(order.length===0){ order=[0]; }
  idx = 0; showingMeaning = false; render();
}

function render(){
  const i = order[idx] ?? 0;
  const term = flashcards[i][0];
  const meaning = flashcards[i][1];
  elTerm.textContent = term;
  elMeaning.textContent = meaning;
  elMeaning.classList.toggle('hidden', !showingMeaning);
  elProgress.textContent = "カード " + (idx+1) + " / " + order.length;
  const isKnown = known.has(i);
  elStatus.textContent = isKnown ? "既習" : "未習得";
  elTotal.textContent = "合計 " + flashcards.length + " 枚";
}

function flip(){ showingMeaning = !showingMeaning; render(); }
function next(){ idx = (idx+1) % order.length; showingMeaning=false; render(); }
function prev(){ idx = (idx-1 + order.length) % order.length; showingMeaning=false; render(); }
function markKnown(v){
  const i = order[idx];
  if(v) known.add(i); else known.delete(i);
  saveKnown(known); render();
}

/* === イベント === */
elFlip.addEventListener('click', flip);
elNext.addEventListener('click', next);
elPrev.addEventListener('click', prev);
elAgain.addEventListener('click', ()=>markKnown(false));
elGood.addEventListener('click', ()=>markKnown(true));
elShuffle.addEventListener('click', ()=>{ order.sort(()=>Math.random()-0.5); idx=0; render(); });
elFilter.addEventListener('change', applyFilterAndSearch);
elQ.addEventListener('input', applyFilterAndSearch);
document.getElementById('resetLocal').addEventListener('click', ()=>{ known.clear(); saveKnown(known); applyFilterAndSearch(); });

document.addEventListener('keydown', (e)=>{
  if(e.key===' ' || e.key==='Enter'){ e.preventDefault(); flip(); }
  if(e.key==='ArrowRight') next();
  if(e.key==='ArrowLeft') prev();
});

// スワイプ（ボタン押下で始まったタッチは最後まで無視）
let touchStartX = null;
let touchStartedOnButton = false;

function isButtonArea(target){
  return !!(target.closest('button') || target.closest('.actions'));
}

elCard.addEventListener('touchstart', (e)=>{
  touchStartedOnButton = isButtonArea(e.target);
  if (touchStartedOnButton) { touchStartX = null; return; }
  touchStartX = e.changedTouches[0].clientX;
}, {passive:true});

elCard.addEventListener('touchend', (e)=>{
  // ボタン上で始まったタッチなら、離れた場所がどこでも無視
  if (touchStartedOnButton) { touchStartedOnButton = false; return; }

  const start = touchStartX;
  touchStartX = null;
  if (start == null) return;

  const dx = e.changedTouches[0].clientX - start;
  if (Math.abs(dx) > 40) {
    if (dx < 0) next(); else prev();
  } else {
    flip();
  }
}, {passive:true});
/* === 検索モーダル === */
const LK_REC_KEY = "genai_search_recent_v1";
const elLookup = document.getElementById('lookup');
const elLookupOpen = document.getElementById('lookupOpen');
const elLkp = document.getElementById('lookupModal');
const elLkpQuery = document.getElementById('lkpQuery');
const elLkpClose = document.getElementById('lkpClose');
const elLkpRecent = document.getElementById('lkpRecent');
const elLkpClear = document.getElementById('lkpClear');

function normQuery(s){
  const t = (s||"").replace(/\u3000/g,' ').replace(/\s+/g,' ').trim();
  return t.length > 20 ? t.slice(0,20) : t;
}
function getRecents(){
  try{ return JSON.parse(localStorage.getItem(LK_REC_KEY)||"[]"); }catch(e){ return []; }
}
function saveRecent(q){
  if(!q) return;
  let r = getRecents().filter(x=>x!==q);
  r.unshift(q); if(r.length>5) r = r.slice(0,5);
  localStorage.setItem(LK_REC_KEY, JSON.stringify(r));
}
function renderRecents(){
  const r = getRecents();
  elLkpRecent.innerHTML = '';
  r.forEach(q=>{
    const b = document.createElement('button');
    b.type='button'; b.className='chip'; b.textContent=q;
    b.addEventListener('click', ()=> openLookup(q));
    elLkpRecent.appendChild(b);
  });
}

function buildUrl(site,q){
  const e = encodeURIComponent(q);
  switch(site){
    case 'wiki':  return `https://ja.wikipedia.org/wiki/Special:Search?search=${e}`;
    case 'qiita': return `https://qiita.com/search?q=${e}`;
    case 'ipa':   return `https://www.google.com/search?gbv=1&q=site:ipa.go.jp+${e}`;
    case 'egov':  return `https://www.google.com/search?gbv=1&q=site:elaws.e-gov.go.jp+${e}`;
    case 'google':default: return `https://www.google.com/search?gbv=1&q=${e}`;
  }
}

let lastFocus=null;
function openLookup(q){
  const term = normQuery(q || elLookup.value || elTerm.textContent);
  elLkpQuery.textContent = term || '-';
  renderRecents();
  elLkp.hidden = false;
  document.body.style.overflow='hidden';
  lastFocus = document.activeElement;
  // EnterでWikipediaへ
  elLkp.onkeydown = (e)=>{ if(e.key==='Escape') closeLookup(); if(e.key==='Enter'){ goSearch('wiki'); } };
  // 背景タップ/下スワイプで閉じる
  elLkp.addEventListener('click', (e)=>{ if(e.target.dataset.close) closeLookup(); });
  let startY=null;
  elLkp.addEventListener('touchstart', (e)=>{ if(e.target.classList.contains('lkp-panel')) return; startY=e.changedTouches[0].clientY; }, {passive:true});
  elLkp.addEventListener('touchend', (e)=>{ if(startY==null) return; if(e.changedTouches[0].clientY-startY>60) closeLookup(); startY=null; }, {passive:true});
}
function closeLookup(){
  elLkp.hidden = true;
  document.body.style.overflow='';
  if(lastFocus && lastFocus.focus) lastFocus.focus();
}

function goSearch(site){
  const q = normQuery(elLkpQuery.textContent);
  if(!q){ return; }
  saveRecent(q);
  window.location.href = buildUrl(site,q); // 同タブ遷移
}

// イベント
elLookupOpen.addEventListener('click', ()=> openLookup(elLookup.value));
elLookup.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); openLookup(elLookup.value); }});
elLkpClose.addEventListener('click', closeLookup);
document.querySelectorAll('.lkp-site').forEach(b=>{
  b.addEventListener('click', ()=> goSearch(b.dataset.site));
});
elLkpClear.addEventListener('click', ()=>{ localStorage.removeItem(LK_REC_KEY); renderRecents(); });
  
// --- iOSキーボード対策：lookup を見える位置に＆下余白 ---
const vv = window.visualViewport;
function ensureLookupVisible() {
  try {
    elLookup.scrollIntoView({block: 'center'}); // 入力欄を中央に持ってくる
  } catch(e) {}
}
elLookup.addEventListener('focus', ensureLookupVisible);

// キーボード出現時はボトム余白を付与（戻ると消す）
if (vv) {
  const padTarget = document.querySelector('main'); // 余白を付ける場所
  const onVV = () => {
    const overlap = Math.max(0, (window.innerHeight - vv.height)); // だいたいキーボードの高さ
    padTarget.style.paddingBottom = overlap ? (overlap + 24) + 'px' : '';
  };
  vv.addEventListener('resize', onVV);
  vv.addEventListener('scroll', onVV);
}

// 初期化
document.addEventListener('DOMContentLoaded', applyFilterAndSearch);
</script>
</body>
</html>
